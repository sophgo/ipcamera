#include <stdio.h>
#include <sys/prctl.h>
#include "linux/cvi_type.h"
#include "app_ipcam_comm.h"
#include "app_ipcam_pwm.h"

#include "lvgl/lvgl.h"
#include "lvgl/demos/lv_demos.h"
#include "app_ipcam_lvgl.h"

#define FRAMEBUFFER_DEVICE "/dev/fb0"
#define EVENT_DEVICE "/dev/input/event0"

#define LVGL_BACKLIGHT_PWM_ENABLE      1 // 1:Enable. 0:Disable
#define LVGL_BACKLIGHT_PWM_CHIP        4 // PWM6
#define LVGL_BACKLIGHT_PWM_NUM         2
#define LVGL_BACKLIGHT_PWM_PERIOD      100
#define LVGL_BACKLIGHT_PWM_DUCT_CYCLE  80

#define SLIDER_MIN 0
#define SLIDER_MAX 100
#define SLIDER_DEFAULT LVGL_BACKLIGHT_PWM_DUCT_CYCLE

#define LVGL_DEMO_SCROLL_ENABLE        0 // LVGL demo scroll

static APP_PARAM_LVGL_CFG_S stLVGLCfg;
static APP_PARAM_LVGL_CFG_S *pstLVGLCfg = &stLVGLCfg;

static const uint8_t mouse_cursor_icon_map[] = {
    0x19, 0x19, 0x19, 0xb8, 0x1e, 0x1e, 0x1e, 0xc8, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x48, 0x48, 0x48, 0xcc, 0xb2, 0xb2, 0xb2, 0xff, 0x3a, 0x3a, 0x3a, 0xcc, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x0a, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3b, 0x3b, 0x3b, 0xc8, 0xf6, 0xf6, 0xf6, 0xff, 0xdc, 0xdc, 0xdc, 0xff, 0x43, 0x43, 0x43, 0xe0, 0x00, 0x00, 0x00, 0x3b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x0a, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3b, 0x3b, 0x3b, 0xcb, 0xe6, 0xe6, 0xe6, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xe5, 0xe5, 0xe5, 0xff, 0x59, 0x59, 0x59, 0xf3, 0x00, 0x00, 0x00, 0x4f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3c, 0x3c, 0x3c, 0xcb, 0xe9, 0xe9, 0xe9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf5, 0xf5, 0xf5, 0xff, 0x72, 0x72, 0x72, 0xff, 0x00, 0x00, 0x00, 0x73, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3d, 0x3d, 0x3d, 0xcb, 0xe9, 0xe9, 0xe9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x8a, 0x8a, 0x8a, 0xff, 0x00, 0x00, 0x00, 0x90, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x99, 0x99, 0x99, 0x00, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3e, 0x3e, 0x3e, 0xcb, 0xe9, 0xe9, 0xe9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xa2, 0xa2, 0xa2, 0xff, 0x13, 0x13, 0x13, 0xab, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x3f, 0x3f, 0x3f, 0xcb, 0xe9, 0xe9, 0xe9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xb7, 0xb7, 0xb7, 0xff, 0x1f, 0x1f, 0x1f, 0xbb, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x41, 0x41, 0x41, 0xcc, 0xea, 0xea, 0xea, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xca, 0xca, 0xca, 0xff, 0x3d, 0x3d, 0x3d, 0xd8, 0x00, 0x00, 0x00, 0x37, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x41, 0x41, 0x41, 0xcc, 0xea, 0xea, 0xea, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xde, 0xde, 0xde, 0xff, 0x56, 0x56, 0x56, 0xef, 0x00, 0x00, 0x00, 0x4f, 0x00, 0x00, 0x00, 0x00,
    0x42, 0x42, 0x42, 0xcc, 0xea, 0xea, 0xea, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf3, 0xf3, 0xf3, 0xff, 0x76, 0x76, 0x76, 0xff, 0x00, 0x00, 0x00, 0x6b,
    0x43, 0x43, 0x43, 0xcc, 0xea, 0xea, 0xea, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xce, 0xce, 0xce, 0xff, 0x80, 0x80, 0x80, 0xf7, 0x74, 0x74, 0x74, 0xf8, 0x6d, 0x6d, 0x6d, 0xfb, 0x72, 0x72, 0x72, 0xf8, 0x57, 0x57, 0x57, 0xff, 0x0c, 0x0c, 0x0c, 0xb3,
    0x44, 0x44, 0x44, 0xcc, 0xeb, 0xeb, 0xeb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xfb, 0xfb, 0xfb, 0xff, 0xfe, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc9, 0xc9, 0xc9, 0xff, 0x13, 0x13, 0x13, 0xb7, 0x00, 0x00, 0x00, 0x1b, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x0c, 0x29, 0x29, 0x29, 0x07,
    0x45, 0x45, 0x45, 0xcc, 0xe8, 0xe8, 0xe8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xd9, 0xd9, 0xd9, 0xff, 0x5e, 0x5e, 0x5e, 0xff, 0xe2, 0xe2, 0xe2, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x62, 0x62, 0x62, 0xf0, 0x00, 0x00, 0x00, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x45, 0x45, 0x45, 0xcc, 0xf9, 0xf9, 0xf9, 0xff, 0xec, 0xec, 0xec, 0xff, 0x4a, 0x4a, 0x4a, 0xd8, 0x00, 0x00, 0x00, 0x78, 0x8a, 0x8a, 0x8a, 0xfb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc3, 0xc3, 0xc3, 0xff, 0x00, 0x00, 0x00, 0x8b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x58, 0x58, 0x58, 0xd3, 0xd9, 0xd9, 0xd9, 0xff, 0x5e, 0x5e, 0x5e, 0xef, 0x00, 0x00, 0x00, 0x34, 0x00, 0x00, 0x00, 0x00, 0x3b, 0x3b, 0x3b, 0xc7, 0xe9, 0xe9, 0xe9, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf4, 0xf4, 0xf4, 0xff, 0x54, 0x54, 0x54, 0xdc, 0x00, 0x00, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00,
    0x3e, 0x3e, 0x3e, 0xe0, 0x54, 0x54, 0x54, 0xff, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x57, 0x8e, 0x8e, 0x8e, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xb0, 0xb0, 0xb0, 0xff, 0x00, 0x00, 0x00, 0x78, 0x00, 0x00, 0x00, 0x00, 0x0c, 0x0c, 0x0c, 0x04, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x68, 0x00, 0x00, 0x00, 0x4f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x4c, 0x4c, 0x4c, 0xd0, 0xec, 0xec, 0xec, 0xff, 0xff, 0xff, 0xff, 0xfc, 0xf4, 0xf4, 0xf4, 0xff, 0x53, 0x53, 0x53, 0xd8, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1e, 0x1e, 0x1e, 0x00, 0x04, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6f, 0xab, 0xab, 0xab, 0xff, 0xf6, 0xf6, 0xf6, 0xff, 0x80, 0x80, 0x80, 0xff, 0x31, 0x31, 0x31, 0xac, 0x00, 0x00, 0x00, 0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x09, 0x09, 0x09, 0x03, 0x02, 0x02, 0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x2e, 0x2e, 0x2e, 0xd7, 0x38, 0x38, 0x38, 0xc7, 0x00, 0x00, 0x00, 0x47, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

// 鼠标图标参数
static lv_image_dsc_t mouse_cursor_icon = {
    .header.magic = LV_IMAGE_HEADER_MAGIC,
    .header.w = 14,
    .header.h = 20,
    .data_size = 280 * 4,
    .header.cf = LV_COLOR_FORMAT_ARGB8888,
    .data = mouse_cursor_icon_map,
};

static CVI_S32 mouse_init(void)
{
    pstLVGLCfg->indev_mouse = 
        (lv_indev_t *)lv_evdev_create(LV_INDEV_TYPE_POINTER, EVENT_DEVICE);
    if (pstLVGLCfg->indev_mouse == NULL) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, "lv_evdev_create failed. \n");
        return CVI_FAILURE;
    }

    // 设置鼠标光标
    // LV_IMG_DECLARE(mouse_cursor_icon);
    lv_obj_t * mouse_cursor = lv_image_create(lv_screen_active());
    if (mouse_cursor == NULL) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, 
            "lv_image_create failed. mouse_cursor is null. \n");
        return CVI_FAILURE;
    }
    lv_image_set_src(mouse_cursor, &mouse_cursor_icon);
    lv_indev_set_cursor(pstLVGLCfg->indev_mouse, mouse_cursor);

    return 0;
}

static CVI_S32 mouse_deinit(void)
{
    if (pstLVGLCfg->indev_mouse == NULL) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, "indev_mouse is null. \n");
        return CVI_FAILURE;
    }
    lv_evdev_delete(pstLVGLCfg->indev_mouse);

    return 0;
}

static void *Thread_LGVL_Draw(void *arg)
{
    prctl(PR_SET_NAME, "LGVL_DRAW", 0, 0, 0);
    APP_PROF_LOG_PRINT(LEVEL_WARN, "Thread_LGVL_Draw is running. \n")

    while (pstLVGLCfg->stThrParam.bRun_flag) {
        usleep(5*1000);
        lv_task_handler();
    }
    APP_PROF_LOG_PRINT(LEVEL_WARN, "Thread_LGVL_Draw is done. \n")

    return NULL;
}

static void slider_event_cb(lv_event_t * e)
{
    lv_obj_t * slider = NULL;
    int32_t slider_val __attribute__((unused)) = 0;

    if (e == NULL) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, 
            "slider_event_cb input param invalid. \n");
        return;
    }

    slider = lv_event_get_target(e);
    if (slider == NULL) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, 
            "lv_event_get_target failed. \n");
        return;
    }
    slider_val = lv_slider_get_value(slider);
    // printf(">>>>>>>>>>>>>> val:%d. \n", val);

#if LVGL_BACKLIGHT_PWM_ENABLE
    CVI_S32 s32Ret = CVI_SUCCESS;
    // 配置占空比
    s32Ret = app_ipcam_Pwm_Param_Set(LVGL_BACKLIGHT_PWM_CHIP
                                    , LVGL_BACKLIGHT_PWM_NUM
                                    , LVGL_BACKLIGHT_PWM_PERIOD
                                    , slider_val);
    if (s32Ret != CVI_SUCCESS) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, 
            "app_ipcam_Pwm_Param_Set failed. s32Ret:%d. \n", s32Ret);
    }
#endif
}

/**
 * UI界面创建初始化函数，使用LVGL控件
 */
static CVI_S32 lvgl_ui_init(void)
{
#if LVGL_DEMO_SCROLL_ENABLE
    // LVGL内demo scroll
    lv_demo_scroll();
#else
    // 创建滑动条用于控制PWM调整LDC屏幕亮度
    lv_obj_t * slider = lv_slider_create(lv_screen_active());
    if (slider == NULL) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, "lv_slider_create failed. slider is null.\n");
        return CVI_FAILURE;
    }
    lv_obj_set_width(slider, lv_pct(70));
    lv_obj_align(slider, LV_ALIGN_BOTTOM_MID, 0, -20);
    lv_obj_add_event_cb(slider, slider_event_cb, LV_EVENT_VALUE_CHANGED, NULL);
    lv_slider_set_range(slider, SLIDER_MIN, SLIDER_MAX);
    lv_slider_set_value(slider, SLIDER_DEFAULT, LV_ANIM_ON);

#endif
    return CVI_SUCCESS;
}

CVI_S32 app_ipcam_FrmBuf_LVGL_Init(void)
{
    CVI_S32 s32Ret = CVI_SUCCESS;

    APP_PROF_LOG_PRINT(LEVEL_INFO, "app_ipcam_FrmBuf_LVGL_Init begin. \n");

    lv_init();

    /*Linux frame buffer device init*/
    lv_display_t * disp = lv_linux_fbdev_create();
    if (disp == NULL) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, "lv_linux_fbdev_create failed. \n");
        return CVI_FAILURE;
    }
    lv_linux_fbdev_set_file(disp, FRAMEBUFFER_DEVICE);
    lv_linux_fbdev_set_force_refresh(disp, true);

    s32Ret = mouse_init();
    if (s32Ret != CVI_SUCCESS) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, "mouse_init failed. \n");
        return CVI_FAILURE;
    }

    s32Ret = lvgl_ui_init();
    if (s32Ret != CVI_SUCCESS) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, "lvgl_ui_init failed. \n");
        return CVI_FAILURE;
    }

#if LVGL_BACKLIGHT_PWM_ENABLE
    
    /**
     * 初始LDC屏幕的PWM管脚，用于调整屏幕亮度
     * 初始化PWM6，grp：4，chn：2
     */
    app_ipcam_Pwm_Export(LVGL_BACKLIGHT_PWM_CHIP, LVGL_BACKLIGHT_PWM_NUM);
    s32Ret = app_ipcam_Pwm_Param_Set(LVGL_BACKLIGHT_PWM_CHIP
                                    , LVGL_BACKLIGHT_PWM_NUM
                                    , LVGL_BACKLIGHT_PWM_PERIOD
                                    , LVGL_BACKLIGHT_PWM_DUCT_CYCLE);
    if (s32Ret != CVI_SUCCESS) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, 
            "app_ipcam_Pwm_Param_Set failed. s32Ret:%d. \n", s32Ret);
        return CVI_FAILURE;
    }
#endif

    APP_PROF_LOG_PRINT(LEVEL_INFO, "app_ipcam_FrmBuf_LVGL_Init done. \n");

    return CVI_SUCCESS;
}

CVI_S32 app_ipcam_FrmBuf_LVGL_DeInit(void)
{
    CVI_S32 s32Ret = CVI_SUCCESS;

    APP_PROF_LOG_PRINT(LEVEL_INFO, "app_ipcam_FrmBuf_LVGL_DeInit begin. \n");

    s32Ret = mouse_deinit();
    if (s32Ret != CVI_SUCCESS) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, 
            "mouse_deinit failed. s32Ret:%d. \n", s32Ret);
        return CVI_FAILURE;
    }

#if LVGL_BACKLIGHT_PWM_ENABLE
    
    // 初始化PWM6，grp：4，chn：2
    s32Ret = app_ipcam_Pwm_UnExport(LVGL_BACKLIGHT_PWM_CHIP
                                    , LVGL_BACKLIGHT_PWM_NUM);
    if (s32Ret != CVI_SUCCESS) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, 
            "app_ipcam_Pwm_UnExport failed. s32Ret:%d. \n", s32Ret);
        return CVI_FAILURE;
    }
#endif

    APP_PROF_LOG_PRINT(LEVEL_INFO, "app_ipcam_FrmBuf_LVGL_DeInit done. \n");

    return CVI_SUCCESS;
}

CVI_S32 app_ipcam_FrmBuf_LVGL_Start(void)
{
    CVI_S32 s32Ret = CVI_SUCCESS;

    APP_PROF_LOG_PRINT(LEVEL_INFO, "app_ipcam_FrmBuf_LVGL_Start begin. \n");

    pstLVGLCfg->stThrParam.bRun_flag = CVI_TRUE;
    s32Ret = pthread_create(&pstLVGLCfg->stThrParam.mRun_PID, NULL, Thread_LGVL_Draw, NULL);
    if (s32Ret != CVI_SUCCESS) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, "pthread_create failed!\n");
        pstLVGLCfg->stThrParam.bRun_flag = CVI_FALSE;
        return CVI_FAILURE;
    }

#if LVGL_BACKLIGHT_PWM_ENABLE
    s32Ret = app_ipcam_Pwm_Enable(LVGL_BACKLIGHT_PWM_CHIP, LVGL_BACKLIGHT_PWM_NUM);
    if (s32Ret != CVI_SUCCESS) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, 
            "app_ipcam_Pwm_Enable failed. s32Ret:%d. \n", s32Ret);
        return CVI_FAILURE;
    }
#endif

    APP_PROF_LOG_PRINT(LEVEL_INFO, "app_ipcam_FrmBuf_LVGL_Start done. \n");

    return CVI_SUCCESS;
}

CVI_S32 app_ipcam_FrmBuf_LVGL_Stop(void)
{
    APP_PROF_LOG_PRINT(LEVEL_INFO, "app_ipcam_FrmBuf_LVGL_Stop begin. \n");

    pstLVGLCfg->stThrParam.bRun_flag = CVI_FALSE;
    if (pstLVGLCfg->stThrParam.mRun_PID > (pthread_t)0) {
        pthread_join(pstLVGLCfg->stThrParam.mRun_PID, NULL);
        pstLVGLCfg->stThrParam.mRun_PID = 0;
    }

#if LVGL_BACKLIGHT_PWM_ENABLE
    CVI_S32 s32Ret = CVI_SUCCESS;

    s32Ret = app_ipcam_Pwm_Disable(LVGL_BACKLIGHT_PWM_CHIP, LVGL_BACKLIGHT_PWM_NUM);
    if (s32Ret != CVI_SUCCESS) {
        APP_PROF_LOG_PRINT(LEVEL_ERROR, 
            "app_ipcam_Pwm_Disable failed. s32Ret:%d. \n", s32Ret);
        return CVI_FAILURE;
    }
#endif

    APP_PROF_LOG_PRINT(LEVEL_INFO, "app_ipcam_FrmBuf_LVGL_Stop done. \n");

    return CVI_SUCCESS;
}
